---
title: "Tile AOI"
author: "B Steele"
date: "2023-03-14"
output: html_document
---

# Purpose

This script takes an area of interest (AOI) and creates tiles within the extent for use in eePlumB. While this script is built around Lake Superior, it could easily be adapted to any other lake.

```{r}
library(tidyverse)
library(sf)

#point to directory where your shapefile lives
shp_dir = '/Users/steeleb/Documents/GitHub/Superior-Plume-Bloom/data/aoi/'
```

# Tile AOI

## Read in AOI shapefile

```{r}
shape = read_sf(file.path(shp_dir, 'NHDPlusHR', 'NHDPlusHR_superior_crop_noHarbor.shp'))

#plot quickly to confirm
plot(shape['Feature'])
```

## Tile shapefile using `st_make_grid`

You might need to play around with the cellsize to adjust the grid your your needs and so that it 'makes sense' for your purposes.

```{r}
tiles = st_make_grid(shape,
                     cellsize = c(35000, 25000))#units are square meters for Superior
tiles = tiles[shape]

#plot quickly to confirm
plot(tiles)
plot(shape['Feature'], add = T)
```

For our purposes, we're going to remove the top row of tiles, because we aren't as interested in that area - the upper boundary was already an approximation. Tiles are numbered left to right, bottom to top.

```{r}
tiles_sub = tiles[1:19]
plot(tiles_sub)
plot(shape['Feature'], add = T)
```

And we'll clip the AOI to the extent of these boxes.

```{r}
shape_clip = st_crop(shape, st_bbox(tiles_sub))

plot(tiles_sub)
plot(shape_clip['Feature'], add = T)
```

And now, we need to merge a few tiles for better context. We'll split out the unmerged tiles into two sets so that we can maintain the left to right, bottom to top numbering

```{r}
tiles_toMerge_1 = tiles_sub[c(1, 2)]
tiles_toMerge_2 = tiles_sub[c(3, 4)]
tiles_other_1 = tiles_sub[c(5:10)]
tiles_toMerge_3 = tiles_sub[c(11, 12)]
tiles_other_2 = tiles_sub[c(13:19)]

tiles_merged_1 = st_union(tiles_toMerge_1) 
tiles_merged_2 = st_union(tiles_toMerge_2) 
tiles_merged_3 = st_union(tiles_toMerge_3) 

# sadly, there's no 'easy' way to join these two sfc's with any dplyr or sf method that I can find, so we'll convert to a data frame, join, then convert back to sf

tiles_forLabel = full_join(as.data.frame(tiles_merged_1),
                           as.data.frame(tiles_merged_2)) %>% 
  full_join(as.data.frame(tiles_other_1)) %>% 
  full_join(as.data.frame(tiles_merged_3)) %>% 
  full_join(as.data.frame(tiles_other_2)) %>% 
  st_as_sf() 

plot(tiles_forLabel)
plot(shape_clip['Feature'], add = T, col = alpha('Green', 0.7))
```

Now, intersect to create individual AOIs by tile

```{r}
shape_tiles = st_intersection(shape_clip, tiles_forLabel) #warning okay

plot(shape_tiles['Feature'])
#check to make sure each tile is separate.
plot(shape_tiles['Feature'][1,])
```

## Save each of the tiles as individual features

```{r}
shape_tiles <- shape_tiles %>% 
  rowid_to_column() %>% 
  select(-c(OID_:Shape_Area))

for(l in 1:nrow(shape_tiles)) {
  filename = paste0('SuperiorAOI_', l, '.shp')
  st_write(shape_tiles[shape_tiles$rowid == l,], file.path(shp_dir, 'tiledAOI', filename))
}
```

# Upload to GEE

Go to the GEE IDE and upload the assets you just made to your project of choice. In future iterations, this may be part of the script.
